---
title: "AWS IoT Coreã®ä»£ç”¨ã«ãªã‚‹MQTTãƒ–ãƒ­ãƒ¼ã‚«ã‚’Ubuntuã§ä½œæˆã™ã‚‹"
emoji: "ğŸ¦”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: true
---

# å‹•æ©Ÿ

- ESP32ï¼ˆM5Stackï¼‰ã‹ã‚‰ã®ã‚»ãƒ³ã‚µè¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã‚Œã¾ã§ã¯AWSã®IoT Coreã¨DynamoDBã‚’ä½¿ã£ã¦ä¿å­˜ã—ã¦ããŸãŒã€å¤–éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã‚ãšã«å®Ÿç¾ã—ãŸããªã£ãŸãŸã‚ã€‚
- Oracle Cloud Infrastructureï¼ˆOCIï¼‰ã§ç„¡æ–™ã§ä½¿ãˆã‚‹ä»®æƒ³ãƒã‚·ãƒ³ã‚’æ‰‹ã«å…¥ã‚ŒãŸã®ã§ãã“ã«MQTTã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã§ãã‚Œã°ä½•ã‹ã¨ä½¿ãˆãã†

# MQTTãƒ–ãƒ­ãƒ¼ã‚«ã¸ã®è¦æ±‚äº‹é …

AWS IoT Coreã¨ã®äº’æ›æ€§ã‚’å–ã‚‹ãŸã‚æ§‹ç¯‰ã™ã‚‹MQTTãƒ–ãƒ­ãƒ¼ã‚«ã«ã¯ä»¥ä¸‹ã®äº‹é …ã‚’è¦æ±‚

- TLSå¯¾å¿œï¼ˆä»Šå›ã¯Root CAã‚’è‡ªå‰ã§ä½œæˆï¼‰
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã®å¿…é ˆåŒ–
- ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ã¯ä¸è¦ã¨ã™ã‚‹

# å‹•ä½œç’°å¢ƒ

- Ubuntu 24.04 x 2

ä»Šå›ã¯OCIä¸Šã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’2ã¤ä½œæˆã—ã¦æ¤œè¨¼ã‚’è¡Œã£ãŸ

# äº‹å‰æº–å‚™

ã„ã¤ã‚‚ã®

```bash
sudo apt update -y
sudo apt upgrade -y
```

OpenSSLã€MQTTãƒ–ãƒ­ãƒ¼ã‚«ã€MQTTã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨èµ·å‹•

```bash
sudo apt-get install openssl mosquitto mosquitto-clients -y
sudo systemctl start mosquitto
sudo systemctl enable mosquitto
```

# è¨¼æ˜æ›¸ã€ç§˜å¯†éµã€å…¬é–‹éµã®ä½œæˆ

è¨¼æ˜æ›¸ã€éµç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãã“ã§ä½œæ¥­ã‚’è¡Œã†

```bash
mkdir ~/certs
cd ~/certs
```

## èªè¨¼æ©Ÿé–¢ï¼ˆCAï¼‰ç”¨ãƒ•ã‚¡ã‚¤ãƒ«

CAã®ç§˜å¯†éµã¨ãƒ«ãƒ¼ãƒˆè¨¼æ˜æ›¸ã‚’ç”Ÿæˆã€‚ã“ã“ã§ã¯è¨¼æ˜æ›¸ã®æœ‰åŠ¹æœŸé™ã‚’100å¹´ã«è¨­å®šã—ã¦ã„ã‚‹ã€‚

```bash
openssl genrsa -out ca.key 2048
openssl req -new -x509 -days 36500 -key ca.key -out ca.crt
```

ã„ãã¤ã‹è³ªå•ãŒã§ã¦ãã‚‹ãŒã€åŸºæœ¬çš„ã«ã¯ç©ºã§è‰¯ã„ã€‚**ãŸã ã—ã€Common Nameã¯ã“ã‚Œä»¥é™ä½œæˆã™ã‚‹ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ã‚„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã¨ã¯ç•°ãªã‚‹åå‰ã«è¨­å®šã™ã‚‹ã“ã¨ã€‚**

## ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸

```bash
openssl genrsa -out server.key 2048
openssl req -new -key server.key -out server.csr
openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 36500
```

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸

```bash
openssl genrsa -out client.key 2048
openssl req -new -key client.key -out client.csr
openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client.crt -days 36500
```

## ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ã€MQTTãƒ–ãƒ­ãƒ¼ã‚«ã®è¨­å®š

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç”Ÿæˆã•ã‚ŒãŸç§˜å¯†éµï¼ˆ.keyï¼‰ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒ600ã«ãªã£ã¦ãŠã‚Šã€ã“ã‚Œã§ã¯ã‚µãƒ¼ãƒ“ã‚¹å´ãŒç§˜å¯†éµã‚’èª­ã¿è¾¼ã‚ãªã„ã®ã§æ‰€æœ‰è€…ä»¥å¤–ã«ãƒ•ã‚¡ã‚¤ãƒ«ã®Readæ¨©é™ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```bash 
chmod 644 server.key
```

mosquittoã®éµé…ç½®ç”¨ãƒ•ã‚©ãƒ«ãƒ€ã«CAã¨ã‚µãƒ¼ãƒãƒ¼ã®è¨¼æ˜æ›¸ã€ç§˜å¯†éµã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚

```bash
sudo cp ca.crt server.crt server.key /etc/mosquitto/certs/
```

æ¬¡ã«ã€`/etc/mosquitto/mosquitto.conf`ã«æ¬¡ã‚’è¿½è¨˜ã™ã‚‹ã€‚ãªãŠã€ãƒãƒ¼ãƒˆç•ªå·ã¯MQTTã§1883ã€MQTTSã§8883ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãªã£ã¦ã„ã‚‹ã€‚

```
# Allow no username and passwd
allow_anonymous true

# Enable TLS
listener 8883

# Set CA, Server certificate, Server private key
cafile    /etc/mosquitto/certs/ca.crt
certfile  /etc/mosquitto/certs/server.crt
keyfile   /etc/mosquitto/certs/server.key

# Require certificate from clients
require_certificate true
```

mosquittoã‚’å†èµ·å‹•ã—ã¦è¨­å®šã‚’åæ˜ ã•ã›ã‚‹ã€‚

```bash
sudo systemctl restart mosquitto
```

æ¥ç¶šã™ã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯`ca.crt`ã¨`client.crt`ã€`client.key`ã‚’å…±æœ‰ã—ã¦ãŠãã€‚

## ãƒ†ã‚¹ãƒˆï¼ˆmosquitto-clientsï¼‰

MQTTãƒ–ãƒ­ãƒ¼ã‚«ã¨ç•°ãªã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰æ¥ç¶šã™ã‚‹å ´åˆã¯8883ç•ªãƒãƒ¼ãƒˆã‚’é–‹æ”¾ã™ã‚‹ã®ã‚’å¿˜ã‚Œãšã«ã€‚

Publishå´ã®ä¾‹

```bash
mosquitto_pub -h localhost -p 8883 --cafile ~/certs/ca.crt --cert ~/certs/client.crt --key ~/certs/client.key -t test -m "hello tls" -d
```

Subscribeå´ã®ä¾‹

```bash
mosquitto_sub -h localhost -p 8883 --cafile ~/certs/ca.crt --cert ~/certs/client.crt --key ~/certs/client.key -t test -d
```

## ãƒ†ã‚¹ãƒˆï¼ˆpaho-mqttï¼‰

Pythonã§æ¥ç¶šã™ã‚‹ä¾‹

ã‚ã‚‰ã‹ã˜ã‚paho-mqttã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠã

```bash
pip install paho-mqtt
```

ä»¥ä¸‹ã®ä¾‹ã§ã¯3ç§’ã”ã¨ã«Publishå´ã‹ã‚‰ä¹±æ•°ã‚’ãƒˆãƒ”ãƒƒã‚¯`test`ã«é€ä¿¡ã™ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚’è¡Œã†ã«ã¯`USER`ã€`PASSWORD`ã€`mqttc.username_pw_set(username=USER, password=PASSWORD)`ã®è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã™ã‚‹ã€‚

Subscribeå´ï¼ˆHOSTã«MQTTãƒ–ãƒ­ãƒ¼ã‚«ã®IPã‹DNSã‚’æŒ‡å®šã€‚è¨¼æ˜æ›¸ãªã©ã®ãƒ‘ã‚¹ã¯å„è‡ªã®ç’°å¢ƒã«å¿œã˜ã¦å¤‰æ›´ï¼‰

```python
import paho.mqtt.client as mqtt
import ssl

# MQTT Broker
HOST = 'Set HOST IP or DNS here'
PORT = 8883
KEEP_ALIVE = 60
TOPIC = 'test'
# USER = 'testuser'
# PASSWORD = 'password'
CA_CERT = '/home/ubuntu/certs/ca.crt'
DEVICE_CERT = '/home/ubuntu/certs/client.crt'
DEVICE_KEY = '/home/ubuntu/certs/client.key'

def on_connect(mqttc, obj, flags, rc):
    print('connected: ',rc)

def on_message(mqttc, obj, msg):
    print(msg.topic + ' ' + str(msg.qos) + ' ' + str(msg.payload.decode('utf-8')))

# Connect to MQTT broker
mqttc = mqtt.Client(protocol=mqtt.MQTTv311)
mqttc.on_connect = on_connect
mqttc.on_message = on_message

mqttc.tls_set(ca_certs=CA_CERT, certfile=DEVICE_CERT, keyfile=DEVICE_KEY)
# mqttc.username_pw_set(username=USER, password=PASSWORD)
mqttc.tls_insecure_set(True)

mqttc.connect(HOST,PORT,KEEP_ALIVE)
mqttc.subscribe(TOPIC)
mqttc.loop_forever()
```

Publishå´ï¼ˆHOSTã«MQTTãƒ–ãƒ­ãƒ¼ã‚«ã®IPã‹DNSã‚’æŒ‡å®šã€‚è¨¼æ˜æ›¸ãªã©ã®ãƒ‘ã‚¹ã¯å„è‡ªã®ç’°å¢ƒã«å¿œã˜ã¦å¤‰æ›´ï¼‰

```python
import paho.mqtt.client as mqtt
import time
import random
import ssl

# MQTT Broker
HOST = 'Set HOST IP or DNS here'
PORT = 8883
KEEP_ALIVE = 60
TOPIC = 'test'
# USER = 'testuser'
# PASSWORD = 'password'
CA_CERT = '/home/ubuntu/certs/ca.crt'
DEVICE_CERT = '/home/ubuntu/certs/client.crt'
DEVICE_KEY = '/home/ubuntu/certs/client.key'

def on_connect(mqttc, obj, flags, rc):
    print('connected: ',rc)

# Connect to MQTT broker
mqttc = mqtt.Client()
mqttc.on_connect = on_connect
mqttc.tls_set(ca_certs=CA_CERT, certfile=DEVICE_CERT, keyfile=DEVICE_KEY)
mqttc.tls_insecure_set(True)
# mqttc.username_pw_set(username=USER, password=PASSWORD)
mqttc.connect(HOST,PORT,KEEP_ALIVE)

while True:
    test_data1 = random.randint(0, 100)
    test_data2 = random.randint(0, 100)
    test_data3 = random.randint(0, 100)
    mqttc.publish(TOPIC, f'{{"test_data1": {test_data1}, "test_data2": {test_data2}, "test_data3": {test_data3},}}')
    print('publish')
    time.sleep(3)
```

ä»¥ä¸Šã«ã‚ˆã‚ŠAWS IoT Coreã¨åŒæ§˜ãªMQTTãƒ–ãƒ­ãƒ¼ã‚«ã‚’Ubuntuä¸Šã«æ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ããŸã€‚

# å‚è€ƒã«ã—ãŸã‚‚ã®

@[card](https://qiita.com/Nenshu_agetai/items/b000cd33027ac17dea9f)
@[card](https://www.gravio.com/en-blog/tutorial-how-to-set-up-a-mosquitto-mqtt-broker-securely----using-client-certificates)
